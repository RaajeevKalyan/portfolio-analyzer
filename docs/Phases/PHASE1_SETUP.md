# Phase 1: Docker Infrastructure + Basic Flask App

## âœ… What We're Building

This phase sets up the foundation:
- **2 Docker containers** (nginx + Flask app)
- **HTTPS-only access** with self-signed SSL certificate
- **Basic Flask application** with hello world page
- **Health check endpoints** for monitoring
- **Security hardened nginx** with OWASP best practices

## ğŸ“¦ Files Created

### Docker Infrastructure
```
portfolio-analyzer/
â”œâ”€â”€ docker-compose.yml           # Orchestrates 2 containers
â”œâ”€â”€ Dockerfile                   # Flask app container
â”œâ”€â”€ nginx/
â”‚   â”œâ”€â”€ Dockerfile              # nginx container
â”‚   â”œâ”€â”€ nginx.conf              # Security-hardened config
â”‚   â””â”€â”€ ssl/
â”‚       â””â”€â”€ generate_cert.sh    # SSL certificate generator
```

### Application Files
```
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ __init__.py            # Package initializer
â”‚   â”œâ”€â”€ main.py                # Flask app entry point
â”‚   â””â”€â”€ config.py              # Configuration management
â”œâ”€â”€ requirements.txt           # Python dependencies
â”œâ”€â”€ .env.example              # Environment template
â”œâ”€â”€ .gitignore                # Git ignore rules
â”œâ”€â”€ .dockerignore             # Docker ignore rules
â””â”€â”€ setup.sh                  # Automated setup script
```

## ğŸš€ Installation Steps

### 1. Clone/Create Project Structure

```bash
# Create project directory
mkdir portfolio-analyzer
cd portfolio-analyzer

# Create all files listed above
# (Copy content from artifacts)
```

### 2. Run Automated Setup

```bash
# Make setup script executable
chmod +x setup.sh

# Run setup (creates directories, generates secrets, builds Docker images)
./setup.sh
```

**What `setup.sh` does:**
- Creates `data/`, `logs/`, `nginx/ssl/` directories
- Generates `.env` file with random `SECRET_KEY`
- Creates self-signed SSL certificate
- Builds Docker images

### 3. Start Services

```bash
# Start in detached mode
docker-compose up -d

# View logs
docker-compose logs -f

# View specific service logs
docker-compose logs -f app
docker-compose logs -f nginx
```

### 4. Access Application

Open your browser and navigate to:
```
https://localhost:8443
```

**Expected behavior:**
1. Browser shows SSL warning (expected for self-signed certificate)
2. Click "Advanced" â†’ "Proceed to localhost (unsafe)"
3. See welcome page with:
   - "Portfolio Risk Analyzer" title
   - Broker icons (Font Awesome icons in brand colors)
   - "Application running successfully!" message
   - System info (HTTPS, Flask+Gunicorn+nginx)

## ğŸ§ª Testing

### Test 1: Application Responds
```bash
curl -k https://localhost:8443
# Should return HTML with "Portfolio Risk Analyzer"
```

### Test 2: Health Check
```bash
curl -k https://localhost:8443/health
# Should return: {"status":"healthy","service":"portfolio-analyzer"}
```

### Test 3: HTTP Redirects to HTTPS
```bash
curl -I http://localhost:8080
# Should return: HTTP/1.1 301 Moved Permanently
# Location: https://localhost:8443/
```

### Test 4: Security Headers Present
```bash
curl -I -k https://localhost:8443
# Should include:
# - Strict-Transport-Security
# - X-Frame-Options
# - X-Content-Type-Options
# - Content-Security-Policy
```

### Test 5: Docker Containers Running
```bash
docker-compose ps
# Should show 2 containers:
# - portfolio-app (running)
# - portfolio-nginx (running)
```

### Test 6: Logs Are Clean
```bash
docker-compose logs app | grep ERROR
# Should be empty (no errors)

docker-compose logs nginx | grep error
# Should be empty or only show SSL certificate warnings
```

## ğŸ¨ Visual Verification

When you access `https://localhost:8443`, you should see:

**Broker Icons (Font Awesome):**
- ğŸ›ï¸ Red building (Merrill Lynch)
- ğŸ“ˆ Green chart (Fidelity)  
- ğŸ“Š Purple chart (Webull)
- ğŸ“ˆ Green arrow (Robinhood)
- ğŸ›ï¸ Blue landmark (Schwab)

**Page Elements:**
- Purple gradient background
- White card with shadow
- Bootstrap 5 styling
- Font Awesome 6.5.1 icons
- Responsive layout

## ğŸ”§ Configuration

### Environment Variables (.env)

```bash
# Flask Configuration
FLASK_ENV=production
SECRET_KEY=<auto-generated-by-setup-script>

# Database
DATABASE_URL=sqlite:///data/portfolio.db

# Logging
LOG_LEVEL=INFO

# File Upload Settings
MAX_UPLOAD_SIZE=10485760  # 10MB
ALLOWED_EXTENSIONS=csv

# Application Settings
SNAPSHOT_RETENTION_DEFAULT=25
```

### SSL Certificate

**Location:** `nginx/ssl/cert.pem` and `nginx/ssl/key.pem`

**Validity:** 365 days from generation

**Valid for:** localhost, 127.0.0.1

**To regenerate:**
```bash
cd nginx/ssl
./generate_cert.sh
docker-compose restart nginx
```

## ğŸ“Š Port Mapping

| Service | Internal Port | External Port | Purpose |
|---------|---------------|---------------|---------|
| nginx   | 443          | 8443          | HTTPS   |
| nginx   | 80           | 8080          | HTTP â†’ HTTPS redirect |
| app     | 5000         | (not exposed) | Flask app (internal only) |

## ğŸ› ï¸ Common Commands

```bash
# Start services
docker-compose up -d

# Stop services
docker-compose down

# Restart a service
docker-compose restart app
docker-compose restart nginx

# View logs (real-time)
docker-compose logs -f

# View logs (last 100 lines)
docker-compose logs --tail=100 app

# Rebuild and restart
docker-compose up -d --build

# Enter a container shell
docker-compose exec app bash
docker-compose exec nginx sh

# Check container status
docker-compose ps

# Check resource usage
docker stats portfolio-app portfolio-nginx
```

## ğŸ› Troubleshooting

### Issue: Port 8443 already in use

**Error:** `Bind for 0.0.0.0:8443 failed: port is already allocated`

**Solution:**
```bash
# Find process using port 8443
sudo lsof -i :8443

# Stop the process or change port in docker-compose.yml
# Change to different port:
ports:
  - "9443:443"  # Access at https://localhost:9443
```

### Issue: SSL certificate not trusted

**Symptom:** Browser shows "Your connection is not private"

**Solution:** This is expected for self-signed certificates.
- Click "Advanced"
- Click "Proceed to localhost (unsafe)"
- Or import certificate into system trust store (see browser docs)

### Issue: Permission denied on data/ or logs/

**Error:** `PermissionError: [Errno 13] Permission denied: '/app/data'`

**Solution:**
```bash
# Fix permissions
sudo chown -R 1000:1000 data/ logs/
sudo chmod 700 data/
sudo chmod 755 logs/
```

### Issue: Can't connect to Flask app

**Symptom:** nginx shows "502 Bad Gateway"

**Solution:**
```bash
# Check if app container is running
docker-compose ps

# Check app logs
docker-compose logs app

# Restart app
docker-compose restart app
```

### Issue: Changes not reflected

**Symptom:** Code changes don't appear

**Solution:**
```bash
# Rebuild containers
docker-compose up -d --build

# Or rebuild specific service
docker-compose build app
docker-compose up -d app
```

## âœ… Success Criteria

You've successfully completed Phase 1 if:

- [ ] `docker-compose ps` shows 2 running containers
- [ ] `https://localhost:8443` displays the welcome page
- [ ] Browser shows HTTPS padlock (even with warning)
- [ ] `/health` endpoint returns healthy status
- [ ] No errors in `docker-compose logs`
- [ ] HTTP requests redirect to HTTPS
- [ ] Security headers are present in responses
- [ ] Broker icons display in correct colors

## ğŸ“ˆ Next Steps

**Phase 2: Database Layer**
- Create SQLAlchemy models
- Set up database initialization
- Add Alembic migrations
- Test database connectivity

**Phase 3: CSV Upload (Merrill Lynch)**
- Create upload route
- Build Merrill CSV parser
- Add drag-and-drop UI
- Parse and store positions

---

## ğŸ“ Notes

- This is a **localhost-only** setup
- SSL certificate is **self-signed** (not for production use)
- Database file will be created in `./data/` on first run
- Logs are rotated at 10MB with 10 backups
- All containers run as non-root users
- nginx uses Alpine Linux (smaller image size)
- Flask app uses Python 3.11 slim image

## ğŸ¯ Architecture Reminder

```
Browser (https://localhost:8443)
    â†“
nginx container (TLS termination, security)
    â†“
Flask app container (Gunicorn + Flask)
    â†“
SQLite file (./data/portfolio.db)
```

**2 containers + 1 database file = Complete system**